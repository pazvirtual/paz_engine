#ifndef PAZ_ENGINE
#define PAZ_ENGINE

#include <PAZ_Graphics>
#include <PAZ_IO>
#include <PAZ_Math>
#include <unordered_set>
#include <sstream>

namespace paz
{
    enum class CollisionType
    {
        Default, None, World
    };

    enum class GravityType
    {
        Default, None
    };

    class Triangle;
    class Model
    {
        friend class App;

        std::shared_ptr<std::vector<paz::Triangle>> _t;
        double _radius = 0.;
        VertexBuffer _v;
        IndexBuffer _i;

        double collide(double x, double y, double z, double radius, double&
            xNew, double& yNew, double& zNew, double& xNor, double& yNor,
            double& zNor) const;
        void castRay(double x, double y, double z, double xDir, double yDir,
            double zDir, double& xNor, double& yNor, double& zNor, double& dist)
            const;

    public:
        Model() = default;
        Model(const std::string& path, int idx = 0, double zOffset = 0., double
            scale = 1.);
    };

    class Object
    {
        friend class App;

        const std::uintptr_t _id;

        void setLocalNorX(double n);
        void setLocalNorY(double n);
        void setLocalNorZ(double n);
        void setAltitude(double n);

        double xPrev() const;
        double yPrev() const;
        double zPrev() const;

        virtual void update();
        virtual void onCollide(const Object& o);
        virtual void onInteract(const Object& o);
        virtual void onNotify(const Object& o, const Bytes& data);

    public:
        Object();
        Object(const Object& o);
        Object& operator=(const Object& o);
        virtual ~Object();
        void notify(Object& o, const Bytes& data) const;
        void notifyTagged(const std::string& tag, const Bytes& data) const;
        double& x();
        double x() const;
        double& y();
        double y() const;
        double& z();
        double z() const;
        double& xVel();
        double xVel() const;
        double& yVel();
        double yVel() const;
        double& zVel();
        double zVel() const;
        double& xAtt();
        double xAtt() const;
        double& yAtt();
        double yAtt() const;
        double& zAtt();
        double zAtt() const;
        double& xAngRate();
        double xAngRate() const;
        double& yAngRate();
        double yAngRate() const;
        double& zAngRate();
        double zAngRate() const;
        Model& model();
        const Model& model() const;
        CollisionType& collisionType();
        const CollisionType& collisionType() const;
        GravityType& gravityType();
        const GravityType& gravityType() const;
        double localNorX() const;
        double localNorY() const;
        double localNorZ() const;
        double altitude() const;
        double& collisionHeight();
        double collisionHeight() const;
        double& collisionRadius();
        double collisionRadius() const;
        double xDown() const;
        double yDown() const;
        double zDown() const;
        void addTag(const std::string& tag);
        bool isTagged(const std::string& tag) const;
    };

    class App
    {
    public:
        App() = delete;
        static void Init(const std::string& sceneShaderPath, const std::
            string& fontPath);
        static void Run();
        static void AttachCamera(const Object& o);
        static double CameraYaw();
        static std::stringstream& MsgStream();
        static paz::Bytes GetAsset(const std::string& path);
    };
}

#endif
